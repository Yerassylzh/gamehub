{% extends 'base.html' %}
{% load static %}

{% block links %}
  <link rel="stylesheet" href="{% static 'css/includes/header.css' %}">
  <script src="{% static 'js/includes/club_details.js' %}"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block header %}
	{% include "includes/header.html" %}
{% endblock header %}

{% block main %}
  <div class="col-10 col-md-9 col-xl-5 contents">
    <p class="club-name">{{ club.name }}</p>
  
    {% include 'includes/images_viewer.html' %}

    {% include 'includes/price_section.html' %}

    {% include 'includes/club_description_section.html' %}

    {% include 'includes/feedbacks_section.html' %}

    {% include 'includes/booking.html' %}

    {% include 'includes/contact_info_section.html' %}
  </div>

  <script>
    let CLUB_DETAILS_URL = "{% url 'club:club_details' pk %}"
    let EMPTY_STAR_IMG_URL = "{% static 'img/star_empty.png' %}"
    let FULL_STAR_IMG_URL = "{% static 'img/star_full.png' %}"
    let current_rating = 0

    document.addEventListener("click", e => {
      if (!e.target.matches("#create-feedback-btn") && e.target.closest("#create-feedback-btn") == null) return

      let createFeedbackButton = document.getElementById("create-feedback-btn")
      createFeedbackButton.remove()

      let rating = document.createElement("div")
      rating.setAttribute("class", "rating")
      rating.setAttribute("id", "rating")
      for (let i = 1; i <= 5; i++) {
          let star_img = document.createElement("img")
          star_img.setAttribute("class", "star-img")
          star_img.setAttribute("id", "star-empty" + i.toString())
          star_img.setAttribute("src", EMPTY_STAR_IMG_URL)
          rating.appendChild(star_img)
      }
      
      let feedbackInput = document.createElement("textarea")
      feedbackInput.setAttribute("class", "col-8 col-md-5 col-xl-5 feedback-input")
      feedbackInput.setAttribute("id", "feedback-input")
      
      let saveFeedbackButton = document.createElement("button")
      saveFeedbackButton.setAttribute("class", "save-feedback-btn")
      saveFeedbackButton.setAttribute("id", "save-feedback-btn")
      saveFeedbackButton.textContent = "Сохранить"

      let feedbackInputWrapper = document.createElement("div")
      feedbackInputWrapper.setAttribute("class", "feedback-input-wrapper")
      feedbackInputWrapper.setAttribute("id", "feedback-input-wrapper")

      feedbackInputWrapper.appendChild(rating)
      feedbackInputWrapper.appendChild(feedbackInput)
      feedbackInputWrapper.appendChild(saveFeedbackButton)

      let contentSectionWrapper = document.getElementById("content-bar-wrapper")
      contentSectionWrapper.appendChild(feedbackInputWrapper)
    })

    document.addEventListener("click", e => {
      if (!e.target.matches("#save-feedback-btn") && e.target.closest("#save-feedback-btn") == null) return

      $.ajax({
        method: "POST",
        url: CLUB_DETAILS_URL,
        data: {
          "csrfmiddlewaretoken": CSRF_TOKEN,
          "action": "save-feedback",
          "feedback_message": document.getElementById("feedback-input").value,
          "feedback_rating": current_rating,
        },
        dataType: "json",
        success: function (data) {
          current_rating = 0;

          let feedbackInputWrapper = document.getElementById("feedback-input-wrapper")
          feedbackInputWrapper.remove()

          let contentSectionWrapper = document.getElementById("content-bar-wrapper")

          let statusMessage = document.createElement("p")
          statusMessage.setAttribute("class", "success-message")
          statusMessage.textContent = "Ваш отзыв был успешно добавлен"
          contentSectionWrapper.appendChild(statusMessage)

          let createFeedbackButton = document.createElement("button")
          createFeedbackButton.setAttribute("class", "create-feedback-btn")
          createFeedbackButton.setAttribute("id", "create-feedback-btn")
          createFeedbackButton.textContent = "Оставить отзыв"
          contentSectionWrapper.appendChild(createFeedbackButton)

          
          setTimeout(() => {
            statusMessage.style.opacity = 0;
            setTimeout(() => {
              statusMessage.remove();
            }, 200);
          }, 3000);
        },
        error: function(xhr, errmsg, err) {
          current_rating = 0;

          let contentSectionWrapper = document.getElementById("content-bar-wrapper")
          
          let feedbackInputWrapper = document.getElementById("feedback-input-wrapper")
          feedbackInputWrapper.remove()
          
          let statusMessage = document.createElement("p")
          statusMessage.setAttribute("class", "error-message")
          statusMessage.textContent = "Возникла ошибка"
          contentSectionWrapper.appendChild(statusMessage)

          let createFeedbackButton = document.createElement("button")
          createFeedbackButton.setAttribute("class", "create-feedback-btn")
          createFeedbackButton.setAttribute("id", "create-feedback-btn")
          createFeedbackButton.textContent = "Оставить отзыв"
          contentSectionWrapper.appendChild(createFeedbackButton)
          
          setTimeout(() => {
            statusMessage.style.opacity = 0;
            setTimeout(() => {
              statusMessage.remove();
            }, 200);
          }, 3000);
        }
      })
    })
  
    document.addEventListener("click", e => {
      if (!e.target.matches(".star-img")) return

      let img_id = e.target.id
      current_rating = parseInt(img_id.charAt(img_id.length - 1))
      console.log("curent rating: ", current_rating)

      document.getElementById("rating").remove()

      let rating = document.createElement("div")
      rating.setAttribute("class", "rating")
      rating.setAttribute("id", "rating")
      for (let i = 1; i <= current_rating; i++) {
          let star_img = document.createElement("img")
          star_img.setAttribute("class", "star-img")
          star_img.setAttribute("id", "star-full" + i.toString())
          star_img.setAttribute("src", FULL_STAR_IMG_URL)
          rating.appendChild(star_img)
      }

      for (let i = current_rating + 1; i <= 5; i++) {
        let star_img = document.createElement("img")
        star_img.setAttribute("class", "star-img")
        star_img.setAttribute("id", "star-empty" + i.toString())
        star_img.setAttribute("src", EMPTY_STAR_IMG_URL)
        rating.appendChild(star_img)
      }

      let feedbackInputWrapper = document.getElementById("feedback-input-wrapper")
      feedbackInputWrapper.insertBefore(rating, document.getElementById("feedback-input"))
    })
  </script>
    
  <style>
    .rating {
      gap: 0.3rem;
      display: flex;
      flex-direction: row;

      width: fit-content;
      margin: 0;
      padding: 0;
    }

    .star-img {
      width: 1.5rem;
      height: 1.5rem;
    }

    main {
      background-color: #F5F5F5;
      padding-top: 2rem;
    }

    .success-message {
      font-family: Inter, sans-serif;
      font-weight: 600;
      font-size: 0.7rem;

      color: rgb(0, 240, 0);
    }

    .error-message {
      font-family: Inter, sans-serif;
      font-weight: 600;
      font-size: 0.7rem;

      color: rgb(240, 0, 0);
    }

    .content-bar {
      background-color: white;
      box-shadow: 0 0 16px rgba(153, 153, 153, 0.25);

      padding: 1rem;
      padding-top: 1rem;
      padding-bottom: 1rem;
      
      border-radius: 1rem;
      
      display: flex;
      flex-direction: column;
      justify-content: flex-start;

      margin: 1rem;
      margin-left: 0;
    }

    .club-name {
      font-family: Inter, sans-serif;
      font-weight: 600;
      font-size: calc(1.25rem + 0.8vw);
    }

    .contents {
      display: flex;
      flex-direction: column;
      justify-content: space-evenly;
      align-items: flex-start;
    }

    main {
      display: flex;
      justify-content: center;
      align-items: flex-start;  
    }
  </style>
{% endblock %}
